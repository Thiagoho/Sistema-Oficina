<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Editar Serviço</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body, html {
            background: url('/public/imagemEditarServico.png') no-repeat center;
            background-size: cover;
            min-height: 100vh;
            height: 100%;
        }
        .centraliza {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            padding: 2rem;
            border-radius: 2rem;
            background: rgba(25, 27, 31, 0.93);
            box-shadow: 0 4px 32px 0 rgba(0,0,0,0.39);
            border: 2px solid #20232a;
            color: #fff;
            min-width: 350px;
            max-width: 370px;
        }
        .form-label { color: #80FF44; font-weight: 600; }
        .form-control {
            background: #21252b;
            border: 1px solid #555;
            color: #fff;
        }
        .form-control:focus {
            border-color: #00bfff;
            box-shadow: 0 0 0 0.1rem #00bfff88;
            background: #23272f;
            color: #fff;
        }
        .btn-success {
            background-color: #29b933;
            border-color: #23a12a;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .btn-success:hover {
            background-color: #23a12a;
            border-color: #1e8e23;
        }
        .btn-link, .btn-link:visited {
            color: #00bfff;
            text-decoration: underline;
        }
        .btn-link:hover { color: #ffa600; }
        select.form-control, select {
            background-color: #23272f !important;
            color: #fff !important;
            border: 1px solid #00bfff !important;
        }
        option {
            background: #23272f !important;
            color: #fff !important;
        }
    </style>
</head>
<body>
    <div class="centraliza">
        <div class="card">
            <h2 class="mb-4 text-center">Editar Serviço</h2>
            <form id="servicoForm">
                <div class="mb-3">
                    <label for="nome" class="form-label">Nome do Serviço:</label>
                    <input type="text" class="form-control" id="nome" required>
                </div>
                <div class="mb-3">
                    <label for="descricao" class="form-label">Descrição:</label>
                    <textarea class="form-control" id="descricao" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="precoPadrao" class="form-label">Preço Padrão (R$):</label>
                    <input type="number" step="0.01" class="form-control" id="precoPadrao" required>
                </div>
                <div class="mb-3">
                    <label for="tempoEstimado" class="form-label">Tempo Estimado (min):</label>
                    <input type="number" class="form-control" id="tempoEstimado" required>
                </div>
                <div class="mb-3">
                    <label for="ativo" class="form-label">Ativo?</label>
                    <select class="form-control" id="ativo" required>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="categoria" class="form-label">Categoria:</label>
                    <select class="form-control" id="categoria" required>
                        <option value="">Selecione...</option>
                        <!-- Carregado via JS -->
                    </select>
                </div>
                <button type="submit" class="btn btn-success w-100">Salvar</button>
                <a href="listagemServicos.html" class="btn btn-link w-100 mt-2">Voltar</a>
            </form>
            <div id="mensagem" class="mt-3 text-center"></div>
        </div>
    </div>
    <script>
        // Pega o ID do serviço da URL (?id=...)
        const urlParams = new URLSearchParams(window.location.search);
        const servicoId = urlParams.get('id');

        // Carregar categorias no select
        function carregarCategorias(idAtual) {
            fetch('http://localhost:8080/api/categorias')
                .then(res => res.json())
                .then(categorias => {
                    const select = document.getElementById('categoria');
                    categorias.forEach(cat => {
                        let opt = document.createElement('option');
                        opt.value = cat.idCategoriaServicos;
                        opt.textContent = cat.nome;
                        if (idAtual && idAtual === cat.idCategoriaServicos) {
                            opt.selected = true;
                        }
                        select.appendChild(opt);
                    });
                });
        }

        // Carregar dados do serviço pelo ID
        function carregarServico() {
            fetch(`http://localhost:8080/api/servicos/${servicoId}`)
                .then(res => res.json())
                .then(servico => {
                    document.getElementById('nome').value = servico.nome;
                    document.getElementById('descricao').value = servico.descricao;
                    document.getElementById('precoPadrao').value = servico.precoPadrao;
                    document.getElementById('tempoEstimado').value = servico.tempoEstimado;
                    document.getElementById('ativo').value = servico.ativo ? "true" : "false";
                    carregarCategorias(servico.categoriaServico?.idCategoriaServicos);
                })
                .catch(() => {
                    document.getElementById('mensagem').innerHTML =
                        '<span class="text-danger">Erro ao carregar serviço.</span>';
                });
        }

        document.getElementById('servicoForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const servico = {
                nome: document.getElementById('nome').value,
                descricao: document.getElementById('descricao').value,
                precoPadrao: parseFloat(document.getElementById('precoPadrao').value),
                tempoEstimado: parseInt(document.getElementById('tempoEstimado').value),
                ativo: document.getElementById('ativo').value === "true",
                idCategoriaServico: parseInt(document.getElementById('categoria').value)
            };
            fetch(`http://localhost:8080/api/servicos/${servicoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(servico)
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('mensagem').innerHTML =
                        '<span class="text-success">Serviço atualizado com sucesso!</span>';
                    setTimeout(() => window.location.href = 'servicos.html', 1100);
                } else {
                    return response.text().then(txt => { throw new Error(txt); });
                }
            })
            .catch(error => {
                document.getElementById('mensagem').innerHTML =
                    `<span class="text-danger">Erro: ${error.message}</span>`;
            });
        });

        window.onload = carregarServico;
    </script>
</body>
</html>