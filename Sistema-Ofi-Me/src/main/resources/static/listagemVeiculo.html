<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Listagem de Veículos</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
body {
	background: url('/public/imagemListagem.png') repeat;
	background-size: cover;
	min-height: 100vh;
	font-family: 'Segoe UI', Arial, sans-serif;
}
.centraliza-pagina {
	min-height: 100vh;
	display: flex;
	justify-content: center;
	align-items: flex-start;
}
.container {
	background: rgba(10, 18, 38, 0.92);
	border-radius: 18px;
	box-shadow: 0 8px 38px 0 rgba(0, 0, 0, 0.22);
	padding: 30px 30px 20px 30px;
	margin-top: 40px;
	max-width: 1100px;
}
h3, th, .table th { color: #fff !important; }
.table { background: transparent; color: #fff; border-radius: 14px; overflow: hidden; }
.table th, .table td {
	color: #fff !important;
	background: transparent;
	border-bottom: 1.5px solid #232323;
	padding: 14px 12px;
	font-size: 1.03rem;
}
.table th {
	background: rgba(35, 35, 35, 1) !important;
	font-size: 1.11rem;
	font-weight: 700;
	border-bottom: 2.5px solid #444;
}
.table tbody tr:hover { background: rgba(60, 110, 220, 0.11) !important; transition: background 0.2s; }
.btn-warning {
	color: #fff !important;
	background: linear-gradient(90deg, #f8be29 0%, #ffd259 100%);
	border: 1px solid #fff2;
	font-weight: 600;
}
.btn-danger {
	color: #fff !important;
	background: linear-gradient(90deg, #ed3e3e 0%, #ff6565 100%);
	border: 1px solid #fff2;
	font-weight: 600;
}
.btn-primary { font-weight: 600; background: #2b72ff; }
.row.g-3 { margin-bottom: 12px; }
@media (max-width: 800px) {
	.container { padding: 6px; }
	h3 { font-size: 1.16rem; }
}
</style>
</head>
<body>
<div class="centraliza-pagina">
<div class="container shadow">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h3>Listagem de Veículos</h3>
		<div>
			<button class="btn btn-primary me-2" onclick="abrirModalCadastro()">Cadastrar Veículo</button>
			<a href="dashboard.html" class="btn btn-warning me-2">Dashboard</a>
		</div>
	</div>
	<div class="row g-3 mt-2 mb-3">
	    <div class="col-md-4">
	        <input type="text" id="filtroModelo" placeholder="Filtrar por Modelo" class="form-control" oninput="filtrarVeiculos()">
	    </div>
	</div>

	<table class="table table-bordered align-middle">
		<thead class="table-light">
			<tr>
				<th>Modelo</th>
				<th>Marca</th>
				<th>Placa</th>
				<th>Ano</th>
				<th>Cliente</th>
				<th>Ativo</th>
				<th style="width: 170px;">Ações</th>
			</tr>
		</thead>
		<tbody id="veiculosBody">
			<!-- Conteúdo dinâmico via JS -->
		</tbody>
	</table>
	<div id="mensagem" class="mt-3 text-center"></div>
	<div class="d-flex justify-content-end mt-2">
		<a href="login.html" class="btn btn-link">Voltar para o Login</a>
	</div>
</div>
</div>

<!-- MODAL DE CADASTRO (vazio, será preenchido via JS) -->
<div class="modal fade" id="modalCadastro" tabindex="-1" aria-labelledby="modalCadastroLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content bg-dark text-light" id="cadastroModalContent">
			<!-- Formulário será carregado aqui via JS -->
		</div>
	</div>
</div>

<!-- MODAL DE EDIÇÃO será carregado dinamicamente -->
<div id="editar-modal-container"></div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let veiculos = [];

function carregarVeiculos() {
    fetch('http://localhost:8080/api/veiculos')
        .then(response => response.json())
        .then(data => {
            veiculos = data;
            renderizarVeiculos(veiculos);
        })
        .catch(() => {
            document.getElementById('mensagem').innerHTML =
                '<span class="text-danger">Erro ao carregar veículos.</span>';
        });
}

function renderizarVeiculos(lista) {
    const tbody = document.getElementById('veiculosBody');
    tbody.innerHTML = '';
    if (!lista.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center">Nenhum veículo cadastrado.</td></tr>`;
        return;
    }
    lista.forEach(veiculo => {
        tbody.innerHTML += `
            <tr>
                <td>${veiculo.modelo || ""}</td>
                <td>${veiculo.marca || ""}</td>
                <td>${veiculo.placa || ""}</td>
                <td>${veiculo.ano || ""}</td>
                <td>${veiculo.cliente ? (veiculo.cliente.nome || veiculo.cliente.idCliente) : (veiculo.idCliente || "")}</td>
                <td>${veiculo.ativo == null ? "" : (veiculo.ativo ? 'Sim' : 'Não')}</td>
                <td>
                    <button class="btn btn-warning btn-sm me-1" onclick="abrirModalEditar(${veiculo.idVeiculo})">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="excluirVeiculo(${veiculo.idVeiculo})">Excluir</button>
                </td>
            </tr>
        `;
    });
}

// Função para abrir o modal de edição
function abrirModalEditar(id) {
    const veiculo = veiculos.find(v => v.idVeiculo === id);
    if (!veiculo) return;
    document.getElementById('editarIdVeiculo').value = veiculo.idVeiculo;
    document.getElementById('editarModelo').value = veiculo.modelo || '';
    document.getElementById('editarMarca').value = veiculo.marca || '';
    document.getElementById('editarPlaca').value = veiculo.placa || '';
    document.getElementById('editarAno').value = veiculo.ano || '';
    document.getElementById('editarCliente').value = veiculo.cliente ? veiculo.cliente.idCliente : (veiculo.idCliente || "");
    document.getElementById('editarAtivo').value = veiculo.ativo ? "true" : "false";
    new bootstrap.Modal(document.getElementById('modalEditar')).show();
}

// Função para excluir veículo
function excluirVeiculo(id) {
    if (!confirm('Tem certeza que deseja excluir este veículo?')) return;
    fetch(`http://localhost:8080/api/veiculos/${id}`, { method: 'DELETE' })
        .then(response => {
            if (response.ok) {
                carregarVeiculos();
                document.getElementById('mensagem').innerHTML =
                    '<span class="text-success">Veículo excluído com sucesso!</span>';
                setTimeout(() => {
                    window.location.href = "listagemVeiculo.html"; // Redireciona após 3 segundos
                }, 1000); // 3 segundos = 3000 ms
            } else {
                throw new Error('Não foi possível excluir o veículo.');
            }
        })
        .catch(error => {
            document.getElementById('mensagem').innerHTML =
                '<span class="text-danger">Erro: ' + error.message + '</span>';
        });
}


// Filtro
function filtrarVeiculos() {
	let modelo = document.getElementById("filtroModelo").value.toLowerCase();
	let linhas = document.querySelectorAll("#veiculosBody tr");
	linhas.forEach(linha => {
	    let tdModelo = linha.querySelector("td:nth-child(1)").textContent.toLowerCase();
	    let mostrar = true;
	    if (modelo && !tdModelo.includes(modelo)) mostrar = false;
	    linha.style.display = mostrar ? "" : "none";
	});
}

// MODAL DE CADASTRO (se você quiser, deixe igual já usava antes)
function abrirModalCadastro() {
    fetch('veiculo.html')
        .then(resp => resp.text())
        .then(html => {
            let tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            let form = tempDiv.querySelector('form');
            if (!form) {
                document.getElementById('cadastroModalContent').innerHTML =
                    "<div class='p-4 text-danger'>Erro ao carregar formulário de cadastro!</div>";
            } else {
                document.getElementById('cadastroModalContent').innerHTML = form.outerHTML;
            }
            new bootstrap.Modal(document.getElementById('modalCadastro')).show();

            // Preenche o select de clientes
            let selectCliente = document.getElementById('cliente');
            if (selectCliente) {
                fetch('http://localhost:8080/api/clientes')
                    .then(res => res.json())
                    .then(clientes => {
                        selectCliente.innerHTML = '<option value="">Selecione o Cliente</option>';
                        clientes.forEach(cliente => {
                            const opt = document.createElement('option');
                            opt.value = cliente.idCliente;
                            opt.textContent = cliente.nome;
                            selectCliente.appendChild(opt);
                        });
                    });
            }
            // Evento de submit do formulário de cadastro
            let formCadastro = document.getElementById('veiculoForm');
            if (formCadastro) {
                formCadastro.onsubmit = function(e) {
                    e.preventDefault();
                    const veiculo = {
                        modelo: document.getElementById('modelo').value,
                        marca: document.getElementById('marca').value,
                        placa: document.getElementById('placa').value,
                        ano: parseInt(document.getElementById('ano').value),
                        quilometragem: document.getElementById('quilometragem').value ? parseInt(document.getElementById('quilometragem').value) : null,
                        ativo: parseInt(document.getElementById('ativo').value),
                        idCliente: parseInt(document.getElementById('cliente').value)
                    };
                    fetch('http://localhost:8080/api/veiculos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(veiculo)
                    })
                    .then(resp => {
                        if (resp.ok) {
                            bootstrap.Modal.getInstance(document.getElementById('modalCadastro')).hide();
                            carregarVeiculos();
                            document.getElementById('mensagem').innerHTML =
                                '<span class="text-success">Veículo cadastrado com sucesso!</span>';
                    	    setTimeout(() => {
                    	        window.location.href = "listagemVeiculo.html";
                    	    }, 1000)
                        } else {
                            return resp.text().then(msg => { throw new Error(msg); });
                        }
                    })
                    .catch(error => {
                        document.getElementById('mensagem').innerHTML =
                            '<span class="text-danger">Erro: ' + error.message + '</span>';
                    });
                };
            }
        })
        .catch(() => {
            document.getElementById('cadastroModalContent').innerHTML =
                "<div class='p-4 text-danger'>Erro ao carregar formulário de cadastro!</div>";
        });
}

// Carrega MODAL DE EDIÇÃO e os eventos necessários
fetch('editarVeiculo.html')
  .then(response => response.text())
  .then(html => {
    document.getElementById('editar-modal-container').innerHTML = html;

    // Evento do form de edição
    document.getElementById('formEditarVeiculo').addEventListener('submit', function(e){
        e.preventDefault();
        const id = document.getElementById('editarIdVeiculo').value;
        const atualizado = {
            idVeiculo: id,
            modelo: document.getElementById('editarModelo').value,
            marca: document.getElementById('editarMarca').value,
            placa: document.getElementById('editarPlaca').value,
            ano: parseInt(document.getElementById('editarAno').value),
            idCliente: document.getElementById('editarCliente').value,
            ativo: document.getElementById('editarAtivo').value === "true"
        };
        fetch(`http://localhost:8080/api/veiculos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(atualizado)
        })
        .then(response => {
        	if (response.ok) {
        	    carregarVeiculos();
        	    bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
        	    document.getElementById('mensagem').innerHTML =
        	        '<span class="text-success">Veículo atualizado com sucesso!</span>';
        	    setTimeout(() => {
        	        window.location.href = "listagemVeiculo.html";
        	    }, 1000);
        	} else {
                return response.text().then(msg => { throw new Error(msg); });
            }
        })
        .catch(error => {
            document.getElementById('mensagem').innerHTML =
                '<span class="text-danger">Erro: ' + error.message + '</span>';
        });
    });

    // Preenche o select de clientes no modal de edição
    fetch('http://localhost:8080/api/clientes')
        .then(res => res.json())
        .then(clientes => {
            const select = document.getElementById('editarCliente');
            if (select) {
                select.innerHTML = '<option value="">Selecione o Cliente</option>';
                clientes.forEach(cliente => {
                    const opt = document.createElement('option');
                    opt.value = cliente.idCliente;
                    opt.textContent = cliente.nome;
                    select.appendChild(opt);
                });
            }
        })
        .catch(() => {
            alert('Erro ao carregar clientes!');
        });
  });

window.onload = carregarVeiculos;
</script>
</body>
</html>
