<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Listagem de Veículos</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
body {
	background: url('/public/imagemListagem.png') repeat;
	background-size: cover;
	min-height: 100vh;
	font-family: 'Segoe UI', Arial, sans-serif;
}
.centraliza-pagina {
	min-height: 100vh;
	display: flex;
	justify-content: center;
	align-items: flex-start;
}
.container {
	background: rgba(10, 18, 38, 0.92);
	border-radius: 18px;
	box-shadow: 0 8px 38px 0 rgba(0, 0, 0, 0.22);
	padding: 30px 30px 20px 30px;
	margin-top: 40px;
	max-width: 1100px;
}
h3, th, .table th { color: #fff !important; }
.table { background: transparent; color: #fff; border-radius: 14px; overflow: hidden; }
.table th, .table td {
	color: #fff !important;
	background: transparent;
	border-bottom: 1.5px solid #232323;
	padding: 14px 12px;
	font-size: 1.03rem;
}
.table th {
	background: rgba(35, 35, 35, 1) !important;
	font-size: 1.11rem;
	font-weight: 700;
	border-bottom: 2.5px solid #444;
}
.table tbody tr:hover { background: rgba(60, 110, 220, 0.11) !important; transition: background 0.2s; }
.btn-warning {
	color: #fff !important;
	background: linear-gradient(90deg, #f8be29 0%, #ffd259 100%);
	border: 1px solid #fff2;
	font-weight: 600;
}
.btn-danger {
	color: #fff !important;
	background: linear-gradient(90deg, #ed3e3e 0%, #ff6565 100%);
	border: 1px solid #fff2;
	font-weight: 600;
}
.btn-primary { font-weight: 600; background: #2b72ff; }
.row.g-3 { margin-bottom: 12px; }
@media (max-width: 800px) {
	.container { padding: 6px; }
	h3 { font-size: 1.16rem; }
}
</style>
</head>
<body>
<div class="centraliza-pagina">
<div class="container shadow">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h3>Listagem de Veículos</h3>
		<div>
			<a href="veiculo.html" class="btn btn-primary me-2">Cadastrar Veículo</a>
			<a href="dashboard.html" class="btn btn-warning me-2">Dashboard</a>
		</div>
	</div>
	<!-- Filtros acima da tabela -->
	<div class="row g-3 mt-2 mb-3">
		<div class="col-md-4">
			<input type="text" id="filtroModelo" placeholder="Filtrar por Modelo" class="form-control">
		</div>
		<div class="col-md-4">
			<input type="text" id="filtroPlaca" placeholder="Filtrar por Placa" class="form-control">
		</div>
		<div class="col-md-4">
			<input type="text" id="filtroCliente" placeholder="Filtrar por Cliente" class="form-control">
		</div>
	</div>
	<div class="mb-3">
		<button class="btn btn-success" onclick="filtrarVeiculos()">Pesquisar</button>
		<button class="btn btn-secondary ms-2" onclick="limparFiltros()">Limpar Filtros</button>
	</div>
	<table class="table table-bordered align-middle">
		<thead class="table-light">
			<tr>
				<th>Modelo</th>
				<th>Marca</th>
				<th>Placa</th>
				<th>Ano</th>
				<th>Cliente</th>
				<th>Ativo</th>
				<th style="width: 170px;">Ações</th>
			</tr>
		</thead>
		<tbody id="veiculosBody">
			<!-- Conteúdo dinâmico via JS -->
		</tbody>
	</table>
	<div id="mensagem" class="mt-3 text-center"></div>
	<div class="d-flex justify-content-end mt-2">
		<a href="login.html" class="btn btn-link">Voltar para o Login</a>
	</div>
</div>
</div>

<!-- MODAL DE EDIÇÃO -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content bg-dark text-light">
			<form id="formEditarVeiculo">
				<div class="modal-header">
					<h5 class="modal-title" id="modalEditarLabel">Editar Veículo</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<input type="hidden" id="editarIdVeiculo">
					<div class="mb-3">
						<label for="editarModelo" class="form-label">Modelo:</label>
						<input type="text" id="editarModelo" class="form-control" required>
					</div>
					<div class="mb-3">
						<label for="editarMarca" class="form-label">Marca:</label>
						<input type="text" id="editarMarca" class="form-control">
					</div>
					<div class="mb-3">
						<label for="editarPlaca" class="form-label">Placa:</label>
						<input type="text" id="editarPlaca" class="form-control" required>
					</div>
					<div class="mb-3">
						<label for="editarAno" class="form-label">Ano:</label>
						<input type="number" id="editarAno" class="form-control">
					</div>
					<div class="mb-3">
						<label for="editarCliente" class="form-label">Cliente:</label>
						<select id="editarCliente" class="form-control" required>
							<option value="">Selecione o Cliente</option>
						</select>
					</div>
					<div class="mb-3">
						<label for="editarAtivo" class="form-label">Ativo:</label>
						<select id="editarAtivo" class="form-control">
							<option value="true">Sim</option>
							<option value="false">Não</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-success">Salvar</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let veiculos = [];

function carregarVeiculos() {
    fetch('http://localhost:8080/api/veiculos')
        .then(response => response.json())
        .then(data => {
            veiculos = data;
            renderizarVeiculos(veiculos);
        })
        .catch(() => {
            document.getElementById('mensagem').innerHTML =
                '<span class="text-danger">Erro ao carregar veículos.</span>';
        });
}

function renderizarVeiculos(lista) {
    const tbody = document.getElementById('veiculosBody');
    tbody.innerHTML = '';
    if (!lista.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center">Nenhum veículo cadastrado.</td></tr>`;
        return;
    }
    lista.forEach(veiculo => {
        tbody.innerHTML += `
            <tr>
                <td>${veiculo.modelo || ""}</td>
                <td>${veiculo.marca || ""}</td>
                <td>${veiculo.placa || ""}</td>
                <td>${veiculo.ano || ""}</td>
                <td>${veiculo.cliente ? (veiculo.cliente.nome || veiculo.cliente.idCliente) : (veiculo.idCliente || "")}</td>
                <td>${veiculo.ativo == null ? "" : (veiculo.ativo ? 'Sim' : 'Não')}</td>
                <td>
                    <button class="btn btn-warning btn-sm me-1" onclick="abrirModalEditar(${veiculo.idVeiculo})">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="excluirVeiculo(${veiculo.idVeiculo})">Excluir</button>
                </td>
            </tr>
        `;
    });
}

function abrirModalEditar(id) {
    const veiculo = veiculos.find(v => v.idVeiculo === id);
    if (!veiculo) return;
    document.getElementById('editarIdVeiculo').value = veiculo.idVeiculo;
    document.getElementById('editarModelo').value = veiculo.modelo || '';
    document.getElementById('editarMarca').value = veiculo.marca || '';
    document.getElementById('editarPlaca').value = veiculo.placa || '';
    document.getElementById('editarAno').value = veiculo.ano || '';
    document.getElementById('editarCliente').value = veiculo.cliente ? veiculo.cliente.idCliente : (veiculo.idCliente || "");
    document.getElementById('editarAtivo').value = veiculo.ativo ? "true" : "false";
    new bootstrap.Modal(document.getElementById('modalEditar')).show();
}

document.getElementById('formEditarVeiculo').addEventListener('submit', function(e){
    e.preventDefault();
    const id = document.getElementById('editarIdVeiculo').value;
    const atualizado = {
        idVeiculo: id,
        modelo: document.getElementById('editarModelo').value,
        marca: document.getElementById('editarMarca').value,
        placa: document.getElementById('editarPlaca').value,
        ano: parseInt(document.getElementById('editarAno').value),
        idCliente: document.getElementById('editarCliente').value,
        ativo: document.getElementById('editarAtivo').value === "true"
    };
    fetch(`http://localhost:8080/api/veiculos/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(atualizado)
    })
    .then(response => {
        if (response.ok) {
            carregarVeiculos();
            bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
            document.getElementById('mensagem').innerHTML =
                '<span class="text-success">Veículo atualizado com sucesso!</span>';
        } else {
            return response.text().then(msg => { throw new Error(msg); });
        }
    })
    .catch(error => {
        document.getElementById('mensagem').innerHTML =
            '<span class="text-danger">Erro: ' + error.message + '</span>';
    });
});

function excluirVeiculo(id) {
    if (!confirm('Tem certeza que deseja excluir este veículo?')) return;
    fetch(`http://localhost:8080/api/veiculos/${id}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
            carregarVeiculos();
            document.getElementById('mensagem').innerHTML =
                '<span class="text-success">Veículo excluído com sucesso!</span>';
        } else {
            throw new Error('Não foi possível excluir o veículo.');
        }
    })
    .catch(error => {
        document.getElementById('mensagem').innerHTML =
            '<span class="text-danger">Erro: ' + error.message + '</span>';
    });
}

// Filtro multi-campo para a tabela
function filtrarVeiculos() {
    let modelo = document.getElementById("filtroModelo").value.toLowerCase();
    let placa = document.getElementById("filtroPlaca").value.toLowerCase();
    let cliente = document.getElementById("filtroCliente").value.toLowerCase();

    let linhas = document.querySelectorAll("#veiculosBody tr");
    linhas.forEach(linha => {
        let tdModelo = linha.querySelector("td:nth-child(1)").textContent.toLowerCase();
        let tdPlaca = linha.querySelector("td:nth-child(3)").textContent.toLowerCase();
        let tdCliente = linha.querySelector("td:nth-child(5)").textContent.toLowerCase();

        let mostrar = true;
        if (modelo && !tdModelo.includes(modelo)) mostrar = false;
        if (placa && !tdPlaca.includes(placa)) mostrar = false;
        if (cliente && !tdCliente.includes(cliente)) mostrar = false;

        linha.style.display = mostrar ? "" : "none";
    });
}
function limparFiltros() {
	document.getElementById("filtroModelo").value = "";
	document.getElementById("filtroPlaca").value = "";
	document.getElementById("filtroCliente").value = "";
	filtrarVeiculos();
}
window.onload = function() {
    carregarVeiculos();

    // Carregar os clientes no select de edição
    fetch('http://localhost:8080/api/clientes')
        .then(res => res.json())
        .then(clientes => {
            const select = document.getElementById('editarCliente');
            select.innerHTML = '<option value="">Selecione o Cliente</option>';
            clientes.forEach(cliente => {
                const opt = document.createElement('option');
                opt.value = cliente.idCliente;
                opt.textContent = cliente.nome;
                select.appendChild(opt);
            });
        })
        .catch(() => {
            alert('Erro ao carregar clientes!');
        });
};
</script>
</body>
</html>
